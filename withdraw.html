<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarik Dana - Bird Money</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            background: linear-gradient(135deg, #4B0082 0%, #6B21A8 50%, #7C3AED 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .input-dark {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .input-dark:focus {
            border-color: #f97316;
            outline: none;
        }
        .method-card {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .method-card.selected {
            border-color: #f97316;
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.3);
        }
        .package-card {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .package-card.selected {
            border-color: #f97316;
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.3);
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, #f36d21, #e33b2a);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 5px;
            border-top: 2px solid rgba(255,255,255,0.2);
            border-radius: 25px 25px 0 0;
            z-index: 1000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #fff;
            flex: 1;
        }
        .nav-item img { width: 32px; height: 32px; margin-bottom: 2px; object-fit: contain; }
        .nav-item span { font-size: 12px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .nav-item.active::before {
            content: '';
            position: absolute;
            top: -10px;
            width: 30px;
            height: 4px;
            background: #ffeb3b;
            border-radius: 10px;
            box-shadow: 0 0 10px #ffeb3b;
        }
        .nav-item.active { position: relative; }
        
        /* Scrollbar for history */
        .history-scroll::-webkit-scrollbar { width: 4px; }
        .history-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .history-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body class="text-white font-sans antialiased pb-24">
    
    <div class="p-4 pt-6">
        <h1 class="text-2xl font-black mb-6">Tarik Dana</h1>

        <div class="glass-card rounded-3xl p-5 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-sm opacity-80">Saldo Tersedia</p>
                    <p class="text-3xl font-black text-orange-400">Rp <span id="available-balance">0</span></p>
                </div>
                <div class="bg-gradient-to-r from-orange-500 to-yellow-500 w-14 h-14 rounded-xl flex items-center justify-center">
                    <i class="fas fa-wallet text-2xl"></i>
                </div>
            </div>
            <div class="flex gap-3">
                <div class="flex-1 bg-black/30 rounded-xl p-3 text-center">
                    <p class="text-xs opacity-70">Koin</p>
                    <p class="text-lg font-bold text-yellow-400" id="coin-balance">0</p>
                </div>
                <div class="flex-1 bg-black/30 rounded-xl p-3 text-center">
                    <p class="text-xs opacity-70">Telur</p>
                    <p class="text-lg font-bold text-blue-400" id="egg-balance">0</p>
                </div>
            </div>
        </div>

        <div class="glass-card rounded-3xl p-5 mb-6">
            <h2 class="font-bold mb-4">Pilih Paket Penarikan</h2>
            
            <div class="grid grid-cols-2 gap-3 mb-4" id="package-list">
                <!-- Packages generated by JS -->
            </div>

            <div class="bg-black/30 rounded-xl p-4 space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="opacity-70">Biaya Admin</span>
                    <span class="font-bold" id="admin-fee">Rp 0</span>
                </div>
                <div class="flex justify-between border-t border-white/10 pt-2">
                    <span class="opacity-70">Total Diterima</span>
                    <span class="font-bold text-green-400" id="total-received">Rp 0</span>
                </div>
                <div class="flex justify-between border-t border-white/10 pt-2 text-red-400">
                    <span class="opacity-70">Membutuhkan</span>
                    <span class="font-bold" id="req-text">-</span>
                </div>
            </div>
        </div>

        <div class="glass-card rounded-3xl p-5 mb-6">
            <h2 class="font-bold mb-4">Metode Pembayaran</h2>
            <div class="space-y-3" id="payment-methods">
                <div class="method-card rounded-xl p-4 flex items-center gap-4 cursor-pointer" onclick="selectMethod(this, 'DANA')">
                    <div class="bg-blue-500 w-12 h-12 rounded-xl flex items-center justify-center">
                        <i class="fas fa-wallet text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-bold">DANA</p>
                        <p class="text-xs opacity-70">Instan, 24 jam</p>
                    </div>
                    <i class="fas fa-check-circle text-xl opacity-0"></i>
                </div>
                <div class="method-card rounded-xl p-4 flex items-center gap-4 cursor-pointer" onclick="selectMethod(this, 'GoPay')">
                    <div class="bg-green-500 w-12 h-12 rounded-xl flex items-center justify-center">
                        <i class="fas fa-wallet text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-bold">GoPay</p>
                        <p class="text-xs opacity-70">Instan, 24 jam</p>
                    </div>
                    <i class="fas fa-check-circle text-xl opacity-0"></i>
                </div>
                <div class="method-card rounded-xl p-4 flex items-center gap-4 cursor-pointer" onclick="selectMethod(this, 'Bank')">
                    <div class="bg-purple-500 w-12 h-12 rounded-xl flex items-center justify-center">
                        <i class="fas fa-university text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-bold">Transfer Bank</p>
                        <p class="text-xs opacity-70">1-3 hari kerja</p>
                    </div>
                    <i class="fas fa-check-circle text-xl opacity-0"></i>
                </div>
            </div>
        </div>

        <div class="glass-card rounded-3xl p-5 mb-6" id="account-form" style="display: none;">
            <h2 class="font-bold mb-4">Informasi Akun</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-sm opacity-70 mb-1 block">Nama Penerima</label>
                    <input type="text" id="account-name" placeholder="Nama lengkap" class="input-dark w-full py-3 px-4 rounded-xl">
                </div>
                <div>
                    <label class="text-sm opacity-70 mb-1 block" id="account-label">Nomor DANA</label>
                    <input type="text" id="account-number" placeholder="08xxxxxxxxxx" class="input-dark w-full py-3 px-4 rounded-xl">
                </div>
            </div>
        </div>

        <button onclick="processWithdraw()" id="btn-withdraw" class="w-full bg-gradient-to-r from-orange-500 to-yellow-500 py-4 rounded-2xl font-bold text-lg shadow-xl active:scale-95 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <i class="fas fa-paper-plane mr-2"></i>Tarik Sekarang
        </button>

        <!-- RIWAYAT PENARIKAN BARU -->
        <div class="glass-card rounded-3xl p-5 mt-8 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold">Riwayat Penarikan</h2>
                <span id="history-count" class="text-xs bg-orange-500/20 text-orange-400 px-2 py-1 rounded-full">0 Transaksi</span>
            </div>
            <div id="history-list" class="space-y-3 max-h-96 overflow-y-auto history-scroll">
                <!-- History items will be loaded here -->
                <p class="text-center text-sm opacity-60 py-4">Memuat riwayat...</p>
            </div>
        </div>
        <!-- AKHIR RIWAYAT -->

    </div>

    <nav class="bottom-nav">
        <a href="home.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" alt="Home">
            <span>Home</span>
        </a>
        <a href="Tugas.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/2645/2645850.png" alt="Tugas">
            <span>Tugas</span>
        </a>
        <a href="invite.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/2583/2583158.png" alt="Invite">
            <span>Invite</span>
        </a>
        <a href="withdraw.html" class="nav-item active">
            <img src="https://cdn-icons-png.flaticon.com/512/2489/2489756.png" alt="Tarik">
            <span>Tarik</span>
        </a>
        <a href="profil.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/3033/3033143.png" alt="Profil">
            <span>Profil</span>
        </a>
    </nav>

    <div id="modal-success" class="fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-[100] hidden p-6">
        <div class="bg-gradient-to-br from-green-500 to-green-600 w-full max-w-xs rounded-[35px] p-8 text-center shadow-2xl">
            <div class="bg-white/20 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-white text-4xl"></i>
            </div>
            <h2 class="text-2xl font-black text-white mb-2">Berhasil!</h2>
            <p class="text-sm opacity-90 mb-4">Permintaan penarikan sedang diproses</p>
            <div class="bg-white/20 py-3 px-6 rounded-2xl inline-block mb-4">
                <p class="text-2xl font-black" id="withdraw-amount-display">Rp 0</p>
            </div>
            <p class="text-xs opacity-80 mb-4">Estimasi masuk: 1x24 jam</p>
            <button onclick="closeModal()" class="w-full bg-white/20 border border-white/30 py-3 rounded-2xl font-bold">Tutup</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, onValue, update, push, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCgNKaGKhvNx34CK2N8r979Y1WSrfBqh48",
            authDomain: "bird-money-85873.firebaseapp.com",
            databaseURL: "https://bird-money-85873-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bird-money-85873",
            storageBucket: "bird-money-85873.appspot.com",
            messagingSenderId: "147773799872",
            appId: "1:147773799872:web:3922142ffedbae9f0d1c25"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let userData = null;
        let selectedMethod = null;
        let selectedPackage = null;

        // Konfigurasi Paket Penarikan
        const withdrawPackages = [
            { amount: 50000, coins: 500000, eggs: 500 },
            { amount: 100000, coins: 1000000, eggs: 1000 },
            { amount: 200000, coins: 2000000, eggs: 2000 },
            { amount: 500000, coins: 5000000, eggs: 5000 }
        ];

        function renderPackages() {
            const container = document.getElementById('package-list');
            container.innerHTML = withdrawPackages.map((pkg, index) => `
                <div class="package-card rounded-xl p-3 text-center" onclick="selectPackage(${index}, this)">
                    <p class="font-bold text-lg text-green-400">Rp ${pkg.amount.toLocaleString()}</p>
                    <p class="text-[10px] opacity-70 mt-1">${pkg.coins.toLocaleString()} Koin + ${pkg.eggs} Telur</p>
                </div>
            `).join('');
        }
        renderPackages();

        // Fungsi untuk memuat riwayat penarikan
        function loadWithdrawHistory(uid) {
            const historyRef = ref(db, 'withdrawals/' + uid);
            onValue(historyRef, (snapshot) => {
                const container = document.getElementById('history-list');
                const countEl = document.getElementById('history-count');
                const data = snapshot.val();
                
                if (!data) {
                    container.innerHTML = '<p class="text-center text-sm opacity-60 py-4">Belum ada riwayat penarikan</p>';
                    countEl.innerText = '0 Transaksi';
                    return;
                }

                // Ubah objek menjadi array dan urutkan berdasarkan timestamp (terbaru di atas)
                const historyItems = Object.values(data).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                countEl.innerText = historyItems.length + ' Transaksi';

                container.innerHTML = historyItems.map(item => {
                    // Format Tanggal: Tanggal Bulan Tahun Jam:Menit:Detik
                    let dateStr = "Waktu tidak valid";
                    if (item.timestamp) {
                        const options = { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
                        dateStr = new Date(item.timestamp).toLocaleDateString('id-ID', options);
                    } else if (item.date) {
                        // Fallback jika timestamp tidak ada (data lama)
                        dateStr = item.date;
                    }

                    // Tentukan Status dan Warna
                    let statusText = '';
                    let statusClass = '';
                    let iconStatus = '';

                    if (item.status === 'completed') {
                        statusText = 'DI SETUJUI';
                        statusClass = 'bg-green-500/20 text-green-400 border-green-400/30';
                        iconStatus = '<i class="fas fa-check-circle mr-1"></i>';
                    } else if (item.status === 'rejected') {
                        statusText = 'DI TOLAK';
                        statusClass = 'bg-red-500/20 text-red-400 border-red-400/30';
                        iconStatus = '<i class="fas fa-times-circle mr-1"></i>';
                    } else {
                        statusText = 'PENDING';
                        statusClass = 'bg-yellow-500/20 text-yellow-400 border-yellow-400/30 animate-pulse';
                        iconStatus = '<i class="fas fa-clock mr-1"></i>';
                    }

                    return `
                        <div class="bg-black/20 rounded-xl p-4 border border-white/5">
                            <div class="flex justify-between items-center mb-2">
                                <p class="font-bold text-lg text-white">Rp ${item.amount.toLocaleString()}</p>
                                <span class="text-[10px] font-bold px-2 py-1 rounded-full border ${statusClass}">
                                    ${iconStatus} ${statusText}
                                </span>
                            </div>
                            <div class="flex justify-between items-center text-xs opacity-70 mb-1">
                                <span><i class="fas fa-wallet mr-1"></i> ${item.method}</span>
                                <span>${item.accountNumber}</span>
                            </div>
                            <div class="text-[10px] opacity-50 text-right mt-2 border-t border-white/5 pt-2">
                                <i class="far fa-clock mr-1"></i> ${dateStr}
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // Load User Data
                onValue(ref(db, 'users/' + user.uid), (snapshot) => {
                    userData = snapshot.val();
                    if (userData) {
                        const saldo = userData.saldo || 0;
                        const rpBalance = Math.floor(saldo / 10);
                        document.getElementById('available-balance').innerText = rpBalance.toLocaleString();
                        document.getElementById('coin-balance').innerText = saldo.toLocaleString();
                        document.getElementById('egg-balance').innerText = userData.egg || 0;
                    }
                });
                
                // Load History
                loadWithdrawHistory(user.uid);
            } else {
                window.location.href = "index.html";
            }
        });

        window.selectPackage = function(index, el) {
            document.querySelectorAll('.package-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            selectedPackage = withdrawPackages[index];

            const fee = selectedPackage.amount >= 100000 ? 2500 : 1500;
            const total = selectedPackage.amount - fee;

            document.getElementById('admin-fee').innerText = 'Rp ' + fee.toLocaleString();
            document.getElementById('total-received').innerText = 'Rp ' + total.toLocaleString();
            document.getElementById('req-text').innerText = `${selectedPackage.coins.toLocaleString()} Koin, ${selectedPackage.eggs} Telur`;

            validateForm();
        };

        window.selectMethod = function(el, method) {
            document.querySelectorAll('.method-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.fa-check-circle').classList.add('opacity-0');
            });
            el.classList.add('selected');
            el.querySelector('.fa-check-circle').classList.remove('opacity-0');
            selectedMethod = method;

            const label = document.getElementById('account-label');
            const placeholder = document.getElementById('account-number');
            if (method === 'Bank') {
                label.innerText = 'Nomor Rekening';
                placeholder.placeholder = '1234567890';
            } else {
                label.innerText = 'Nomor ' + method;
                placeholder.placeholder = '08xxxxxxxxxx';
            }

            document.getElementById('account-form').style.display = 'block';
            validateForm();
        };

        function validateForm() {
            const name = document.getElementById('account-name').value;
            const number = document.getElementById('account-number').value;
            
            const hasEnough = userData && 
                              (userData.saldo || 0) >= selectedPackage.coins && 
                              (userData.egg || 0) >= selectedPackage.eggs;

            const isValid = selectedPackage && selectedMethod && name && number && hasEnough;
            
            const btn = document.getElementById('btn-withdraw');
            if (!hasEnough && selectedPackage) {
                btn.innerText = "Saldo Tidak Cukup";
                btn.disabled = true;
            } else {
                btn.innerHTML = `<i class="fas fa-paper-plane mr-2"></i>Tarik Sekarang`;
                btn.disabled = !isValid;
            }
        }

        document.getElementById('account-name').addEventListener('input', validateForm);
        document.getElementById('account-number').addEventListener('input', validateForm);

        window.processWithdraw = function() {
            const name = document.getElementById('account-name').value;
            const number = document.getElementById('account-number').value;

            const withdrawRef = push(ref(db, 'withdrawals/' + currentUser.uid));
            // Tambahkan timestamp untuk sorting yang akurat
            const timestamp = Date.now();
            
            set(withdrawRef, {
                amount: selectedPackage.amount,
                coinCost: selectedPackage.coins,
                eggCost: selectedPackage.eggs,
                method: selectedMethod,
                accountName: name,
                accountNumber: number,
                status: 'pending',
                date: new Date().toLocaleString(), // Untuk tampilan teks fallback
                timestamp: timestamp, // Untuk sorting dan format presisi
                userId: currentUser.uid
            }).then(() => {
                document.getElementById('withdraw-amount-display').innerText = 'Rp ' + selectedPackage.amount.toLocaleString();
                document.getElementById('modal-success').classList.remove('hidden');
            });
        };

        window.closeModal = function() {
            document.getElementById('modal-success').classList.add('hidden');
            // Reset form
            document.querySelectorAll('.package-card').forEach(c => c.classList.remove('selected'));
            selectedPackage = null;
            document.getElementById('admin-fee').innerText = 'Rp 0';
            document.getElementById('total-received').innerText = 'Rp 0';
            document.getElementById('req-text').innerText = '-';
            document.getElementById('account-name').value = '';
            document.getElementById('account-number').value = '';
            validateForm();
        };
    </script>
</body>
</html>