<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bird Money - Beranda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            background: url('https://i.ibb.co.com/0pjCBMCn/wp2556213-wallpaper-doraemon-3d.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            overflow-x: hidden;
        }
        .main-overlay {
            background: rgba(0, 0, 0, 0.4);
            min-height: 100vh;
        }
        .card-orange {
            background: linear-gradient(to bottom, #f36d21, #e33b2a);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        #eye-toggle { cursor: pointer; padding: 5px; }

        .btn-level {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, #f36d21, #e33b2a);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 5px;
            border-top: 2px solid rgba(255,255,255,0.2);
            border-radius: 25px 25px 0 0;
            z-index: 1000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #fff;
            flex: 1;
        }
        .nav-item img {
            width: 32px;
            height: 32px;
            margin-bottom: 2px;
            object-fit: contain;
        }
        .nav-item span {
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .nav-item.active {
            position: relative;
        }
        .nav-item.active::before {
            content: '';
            position: absolute;
            top: -10px;
            width: 30px;
            height: 4px;
            background: #ffeb3b;
            border-radius: 10px;
            box-shadow: 0 0 10px #ffeb3b;
        }

        @keyframes birdClickRight {
            0% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.1) translateY(-20px) rotate(8deg) translateX(10px); }
            100% { transform: scale(1) translateY(0); }
        }
        @keyframes birdClickLeft {
            0% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.1) translateY(-20px) rotate(-8deg) translateX(-10px); }
            100% { transform: scale(1) translateY(0); }
        }
        .animate-bird-right { animation: birdClickRight 0.15s ease-out; }
        .animate-bird-left { animation: birdClickLeft 0.15s ease-out; }

        .energy-glow {
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.7);
            background: linear-gradient(90deg, #ffe100, #ff9500);
        }

        .coin-particle {
            position: fixed;
            pointer-events: none;
            z-index: 999;
            user-select: none;
            transition: all 1.8s cubic-bezier(0.19, 1, 0.22, 1);
        }

        .floating-energy {
            position: absolute;
            animation: floatUp 1s ease-out forwards;
            pointer-events: none;
            z-index: 50;
            color: #f1c40f;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-100px); }
        }
        .math-input {
            background: #fff5f0;
            color: #d35400;
            border: 2px solid transparent;
            border-radius: 12px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s;
        }
        .math-input.correct {
            border-color: #2ecc71;
            background: #e8faf0;
        }
        .btn-inactive {
            background-color: #94a3b8 !important;
            cursor: not-allowed;
        }
        .btn-active {
            background: linear-gradient(to bottom, #f1c40f, #f39c12) !important;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }

        @keyframes floatingButton {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .animate-float-button {
            animation: floatingButton 2s ease-in-out infinite;
        }

        .lock-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            padding: 30px;
            border-radius: 40px;
            backdrop-filter: blur(5px);
            border: 2px dashed rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.3s;
        }
    </style>
</head>
<body class="text-white font-sans antialiased">
    <div class="main-overlay pb-32">
        
        <div class="flex items-center justify-between p-4 pt-6">
            <div class="flex items-center space-x-3">
                <img src="https://i.ibb.co.com/0RdnV5Xp/download-2.png" class="w-10 h-10 rounded-full border-2 border-white shadow-lg">
                <div>
                    <p class="text-[10px] opacity-80 leading-none">Selamat Datang</p>
                    <p id="user-name" class="text-sm font-bold">Memuat...</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <div id="egg-target" class="bg-black/40 px-3 py-1 rounded-full flex items-center space-x-2 border border-white/10 transition-transform duration-200">
                    <i class="fa-solid fa-egg text-blue-300"></i>
                    <span id="egg-count" class="text-sm font-bold text-yellow-400">0</span>
                </div>
            </div>
        </div>

        <div class="px-4 mt-2">
            <div class="card-orange rounded-[30px] p-6 shadow-2xl relative overflow-hidden text-white">
                <p class="text-xs font-medium flex items-center">
                    Saldo Saya! 
                    <span id="eye-toggle" onclick="toggleSaldoVisibility()">
                        <i id="eye-icon" class="fa-solid fa-eye text-[10px] ml-1"></i>
                    </span>
                </p>
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-black mt-1">Rp <span id="balance-rp">0</span></h2>
                    
                    <div id="balance-coin-container" class="bg-black/20 px-3 py-1 rounded-full flex items-center space-x-2 border border-white/10 transition-transform duration-200">
                        <i class="fa-solid fa-coins text-yellow-400"></i>
                        <span id="balance-coin" class="text-sm font-bold">0</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-2 mt-4">
                <div class="bg-blue-500 btn-level">
                    <div>
                        <p class="text-[10px] opacity-90 leading-tight">Level Saya</p>
                        <p id="user-tier-display" class="text-sm font-black">Free</p>
                    </div>
                    <i class="fa-solid fa-rocket text-xs opacity-70"></i>
                </div>
                <div class="bg-emerald-500 btn-level">
                    <div>
                        <p class="text-[10px] opacity-90 leading-tight">Hadiah Level</p>
                        <p id="user-reward-display" class="text-sm font-black">500 Koin</p>
                    </div>
                    <i class="fa-solid fa-coins text-xs opacity-70"></i>
                </div>
                <div class="bg-purple-500 btn-level">
                    <div>
                        <p class="text-[10px] opacity-90 leading-tight">Jatah Level</p>
                        <p id="user-quota-display" class="text-sm font-black">500 Level</p>
                    </div>
                    <i class="fa-solid fa-clipboard-list text-xs opacity-70"></i>
                </div>
            </div>
        </div>

        <div class="flex flex-col items-center justify-center mt-8 relative">
            <p class="text-sm font-bold text-black bg-white/60 px-4 py-1 rounded-full mb-2">Level Terselesaikan</p>
            <h3 class="text-2xl font-black text-yellow-400 drop-shadow-lg mb-4" id="level-display">0/500</h3>
            
            <div id="tap-area" class="relative cursor-pointer transition-transform">
                <img id="bird-img" src="https://i.ibb.co.com/JWhL0KM9/download-1-removebg-preview.png" alt="Rabbit" class="w-56 h-56 object-contain drop-shadow-[0_20px_20px_rgba(0,0,0,0.5)]">
            </div>

            <div id="lock-area" class="hidden lock-container mt-4 animate-float-button">
                <div class="bg-yellow-400 w-20 h-20 rounded-3xl flex items-center justify-center shadow-2xl border-4 border-white/30 mb-4">
                    <i class="fa-solid fa-lock text-4xl text-white"></i>
                </div>
                <p class="text-yellow-400 font-black text-xl uppercase tracking-widest drop-shadow-md">Jatah Level Penuh</p>
                <p class="text-white text-sm font-bold opacity-90">Waktunya Naik Level!</p>
            </div>

            <div id="energy-container" class="w-3/4 bg-black/40 h-8 rounded-full mt-10 p-1.5 flex items-center relative border-2 border-white/30 shadow-2xl overflow-hidden">
                <div class="h-full rounded-full transition-all duration-300 energy-glow" id="energy-bar" style="width: 0%;"></div>
                <div class="absolute inset-0 flex items-center justify-center text-[12px] font-black text-white drop-shadow-md">
                    âš¡ <span id="energy-text">0/30</span>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="home.html" class="nav-item active">
            <img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" alt="Home">
            <span>Home</span>
        </a>
        <!-- Tombol Baru: Naik Level -->
        <a href="upgrade.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/2732/2732834.png" alt="Level">
            <span>Naik Level</span>
        </a>
        <a href="Tugas.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/2645/2645850.png" alt="Tugas">
            <span>Tugas</span>
        </a>
        <a href="invite.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/2583/2583158.png" alt="Invite">
            <span>Invite</span>
        </a>
        <a href="withdraw.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/2489/2489756.png" alt="Tarik">
            <span>Tarik</span>
        </a>
        <a href="profil.html" class="nav-item">
            <img src="https://cdn-icons-png.flaticon.com/512/3033/3033143.png" alt="Profil">
            <span>Profil</span>
        </a>
    </nav>

    <div id="modal-klaim" class="fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-[100] hidden p-6">
        <div class="card-orange w-full max-w-xs rounded-[35px] p-8 text-center shadow-2xl relative border-2 border-white/30">
            <div id="modal-icon" class="text-5xl mb-3">ðŸŽ‰</div>
            <h2 id="modal-title" class="text-2xl font-black text-white">Selamat!</h2>
            <p class="text-sm opacity-90 mb-5 text-white">Anda berhasil mendapatkan</p>
            <div class="flex flex-wrap justify-center gap-2 mb-8">
                <div id="coin-reward-item" class="bg-white/20 py-2 px-4 rounded-2xl inline-flex items-center gap-2 border border-white/20">
                    <img src="https://cdn-icons-png.flaticon.com/512/1292/1292744.png" class="w-6 h-6">
                    <span id="coin-reward-text" class="font-black text-lg text-yellow-200">500 Koin</span>
                </div>
                <div id="bonus-egg-item" class="hidden bg-blue-500/30 py-2 px-4 rounded-2xl inline-flex items-center gap-2 border border-blue-300/20">
                    <i class="fa-solid fa-egg text-blue-200"></i>
                    <span id="egg-reward-text" class="font-black text-lg text-blue-100">+5 Telur</span>
                </div>
            </div>
            <div class="bg-black/20 p-5 rounded-[25px] mb-6 border border-white/10 relative">
                <p class="text-[12px] mb-3 font-bold uppercase tracking-wider text-white/80">Berapa hasil dari <span id="math-question" class="text-white text-lg font-black">?</span></p>
                <div class="flex gap-2 relative">
                    <input type="number" id="math-answer" placeholder="Jawab Disini" class="math-input w-full py-4 text-lg focus:outline-none shadow-inner">
                    <button onclick="generateQuiz()" class="bg-orange-600/80 p-3 rounded-xl hover:bg-orange-500 transition"><i class="fa-solid fa-sync text-white"></i></button>
                </div>
                <div id="success-notif" class="hidden mt-3 flex items-center justify-center gap-2 text-[10px] font-bold text-green-300 animate-bounce">
                    <div class="bg-green-500 w-4 h-4 rounded-full flex items-center justify-center"><i class="fa-solid fa-check text-white text-[8px]"></i></div>
                    <span>Jawaban benar! Silahkan klaim.</span>
                </div>
            </div>
            <button id="btn-klaim" disabled class="btn-inactive w-full py-4 rounded-2xl font-black text-white text-lg shadow-lg active:scale-95 transition-all uppercase tracking-widest">Klaim Sekarang</button>
        </div>
    </div>

    <div id="modal-upgrade" class="fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-[110] hidden p-6">
        <div class="card-orange w-full max-w-xs rounded-[35px] p-8 text-center shadow-2xl border-2 border-white/40">
            <div class="bg-yellow-400 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg border-4 border-white/20">
                <i class="fa-solid fa-rocket text-4xl text-white"></i>
            </div>
            <h2 class="text-xl font-black text-white mb-1 drop-shadow-md">Waktu yang tepat naik Level!</h2>
            <p class="text-xs text-white/80 mb-4">Sekarang sisa Jatah Level-mu</p>
            <div class="bg-[#fef3c7]/90 py-2 px-8 rounded-2xl inline-block mb-6 shadow-inner">
                <span id="upgrade-level-info" class="text-2xl font-black text-[#854d0e]">0/500</span>
            </div>
            <p class="text-[11px] text-white/95 mb-3 px-2 leading-tight font-medium">Yuk Naikkan Levelmu Sekarang agar dapat Jatah lebih banyak dan dapatkan Estimasi Penghasilan hingga:</p>
            <div class="bg-[#fff9e6]/95 py-4 w-full rounded-[20px] mb-6 shadow-lg border border-white/30">
                <span class="text-3xl font-black text-[#78350f]">Rp3.000.000</span>
            </div>
            <div class="space-y-3">
                <button onclick="window.location.href='upgrade.html'" class="animate-float-button w-full py-4 bg-[#10b981] hover:bg-[#059669] rounded-2xl font-black text-white shadow-[0_4px_0_rgb(5,150,105)] transition-all active:translate-y-1 active:shadow-none flex items-center justify-center gap-2 text-lg">
                    <i class="fa-solid fa-arrow-up"></i> Naik Level Sekarang
                </button>
                <button onclick="document.getElementById('modal-upgrade').classList.add('hidden')" class="w-full py-3 bg-white/10 hover:bg-white/20 rounded-2xl font-bold text-white transition-all border border-white/30">Nanti Dulu</button>
            </div>
        </div>
    </div>

    <div id="modal-locked" class="fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-[120] hidden p-6">
        <div class="card-orange w-full max-w-sm rounded-[35px] p-8 text-center shadow-2xl border-2 border-white/40">
            <div class="flex justify-center mb-4">
                 <div class="bg-yellow-400 w-16 h-16 rounded-3xl flex items-center justify-center shadow-lg border-2 border-white/30">
                    <i class="fa-solid fa-lock text-3xl text-white"></i>
                </div>
            </div>
            <h2 class="text-2xl font-black text-white mb-1">Mohon maaf!</h2>
            <p class="text-lg font-bold text-white mb-4">Jatah Level anda sudah penuh!</p>
            <div class="flex justify-center mb-6">
                <div class="border-4 border-white rounded-full px-8 py-2 bg-black/20">
                    <span id="lock-level-text" class="text-2xl font-black text-white">500/500</span>
                </div>
            </div>
            <p class="text-sm text-white font-medium mb-1">Jatah Level tidak akan pernah di Reset</p>
            <p class="text-sm text-white font-medium mb-1">(Kecuali anda Naik Level)</p>
            <p class="text-sm text-white font-medium mb-1">Yuk naikkan Level-mu sekarang!</p>
            <p class="text-sm text-white font-medium mb-6">Dapatkan Jatah Level Hingga <span class="text-yellow-400 font-black">10.000 Level</span> Dan Raih Pendapatan Hingga:</p>
            <div class="bg-yellow-300 py-4 w-full rounded-2xl mb-6 shadow-lg border-b-4 border-yellow-500">
                <span class="text-3xl font-black text-slate-800">Rp 3.000.000</span>
            </div>
            <div class="space-y-3">
                <button onclick="window.location.href='upgrade.html'" class="animate-float-button w-full py-4 bg-red-500 hover:bg-red-600 rounded-2xl font-black text-white border-b-4 border-red-800 transition-all active:translate-y-1 active:border-b-0 text-lg flex items-center justify-center gap-2">
                    <i class="fa-solid fa-arrow-up"></i> Naikkan Level Sekarang
                </button>
                <button onclick="document.getElementById('modal-locked').classList.add('hidden')" class="w-full py-3 bg-blue-400/30 hover:bg-blue-400/50 rounded-2xl font-bold text-white transition-all border border-white/30">Tutup</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCgNKaGKhvNx34CK2N8r979Y1WSrfBqh48",
            authDomain: "bird-money-85873.firebaseapp.com",
            databaseURL: "https://bird-money-85873-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bird-money-85873",
            storageBucket: "bird-money-85873.appspot.com",
            messagingSenderId: "147773799872",
            appId: "1:147773799872:web:3922142ffedbae9f0d1c25"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let currentSaldo = 0;
        let currentLevel = 0;
        let currentEgg = 0;
        let energy = 0;
        let quizResult = 0;
        let lastJumpSide = 'left';
        let isSaldoHidden = localStorage.getItem('saldoHidden') === 'true';

        // PERUBAHAN: Variabel untuk menyimpan konfigurasi dari Database
        let globalTiers = {};
        let currentTierData = { reward: 500, quota: 500, egg: 5 }; // Default fallback

        window.toggleSaldoVisibility = function() {
            isSaldoHidden = !isSaldoHidden;
            localStorage.setItem('saldoHidden', isSaldoHidden);
            renderSaldo();
        }

        function renderSaldo() {
            const rpElement = document.getElementById('balance-rp');
            const eyeIcon = document.getElementById('eye-icon');
            
            if (isSaldoHidden) {
                rpElement.innerText = "â€¢â€¢â€¢â€¢â€¢";
                eyeIcon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                rpElement.innerText = (currentSaldo / 10).toLocaleString();
                eyeIcon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            if(type === 'tap') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else if(type === 'correct') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(523.25, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else if(type === 'coin') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(987.77, audioCtx.currentTime); 
                osc.frequency.exponentialRampToValueAtTime(1318.51, audioCtx.currentTime + 0.05); 
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                osc.start(); osc.stop(audioCtx.currentTime + 0.2);
            } else if(type === 'egg') {
                osc.type = 'square'; osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                osc.start(); osc.stop(audioCtx.currentTime + 0.2);
            }
        }

        function checkLevelStatus(level) {
            const tapArea = document.getElementById('tap-area');
            const lockArea = document.getElementById('lock-area');
            const energyBar = document.getElementById('energy-container');
            const quota = currentTierData.quota; // Menggunakan kuota dinamis

            // Update texts
            document.getElementById('lock-level-text').innerText = `${level}/${quota}`;
            document.getElementById('level-display').innerText = `${level}/${quota}`;
            
            if (level >= quota) {
                tapArea.classList.add('hidden');
                lockArea.classList.remove('hidden');
                energyBar.classList.add('opacity-50', 'pointer-events-none');
            } else {
                tapArea.classList.remove('hidden');
                lockArea.classList.add('hidden');
                energyBar.classList.remove('opacity-50', 'pointer-events-none');
            }
        }

        document.getElementById('lock-area').onclick = () => {
            document.getElementById('modal-locked').classList.remove('hidden');
        };

        function flyCoinsToBalance(startX, startY) {
            const target = document.getElementById('balance-coin-container');
            const targetRect = target.getBoundingClientRect();
            const targetX = targetRect.left + (targetRect.width / 2);
            const targetY = targetRect.top + (targetRect.height / 2);
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const coin = document.createElement('div');
                    coin.innerHTML = `<img src="https://i.ibb.co.com/jkQxzcD5/Pngtree-coin-golden-3d-digital-5879622.png" style="width:40px; height:40px; object-fit:contain;">`;
                    coin.className = 'coin-particle';
                    const scatterX = (Math.random() - 0.5) * 250;
                    const scatterY = (Math.random() - 0.5) * 150;
                    coin.style.left = startX + 'px'; coin.style.top = startY + 'px';
                    document.body.appendChild(coin);
                    requestAnimationFrame(() => {
                        coin.style.opacity = '1'; coin.style.transform = `translate(${scatterX}px, ${scatterY - 200}px) scale(1.2) rotate(${Math.random() * 360}deg)`;
                        playSound('coin');
                        setTimeout(() => {
                            coin.style.left = targetX + 'px'; coin.style.top = targetY + 'px';
                            coin.style.transform = 'translate(0, 0) scale(0.4) rotate(1080deg)';
                            setTimeout(() => { coin.remove(); if(i === 14) { target.style.transform = 'scale(1.3)'; setTimeout(() => target.style.transform = 'scale(1)', 150); } }, 1800);
                        }, 400);
                    });
                }, i * 80);
            }
        }

        function flyEggsToBalance(startX, startY) {
            const target = document.getElementById('egg-target');
            const targetRect = target.getBoundingClientRect();
            const targetX = targetRect.left + (targetRect.width / 2);
            const targetY = targetRect.top + (targetRect.height / 2);
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const egg = document.createElement('div');
                    egg.innerHTML = `<i class="fa-solid fa-egg text-blue-300 text-2xl shadow-lg"></i>`;
                    egg.className = 'coin-particle';
                    const scatterX = (Math.random() - 0.5) * 200;
                    const scatterY = (Math.random() - 0.5) * 100;
                    egg.style.left = startX + 'px'; egg.style.top = startY + 'px';
                    document.body.appendChild(egg);
                    requestAnimationFrame(() => {
                        egg.style.opacity = '1'; egg.style.transform = `translate(${scatterX}px, ${scatterY - 150}px) scale(1.5) rotate(${Math.random() * 40}deg)`;
                        playSound('egg');
                        setTimeout(() => {
                            egg.style.left = targetX + 'px'; egg.style.top = targetY + 'px';
                            egg.style.transform = 'translate(0, 0) scale(0.5) rotate(720deg)';
                            setTimeout(() => { egg.remove(); if(i === 4) { target.style.transform = 'scale(1.4)'; setTimeout(() => target.style.transform = 'scale(1)', 150); } }, 1800);
                        }, 600);
                    });
                }, i * 150);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;

                // 1. Load Global Tier Config dari Database
                onValue(ref(db, 'tiers'), (snapshot) => {
                    globalTiers = snapshot.val() || {};
                    // Trigger update UI setelah config dimuat (jika user data sudah ada)
                    // Namun di sini kita biarkan user listener yang meng-handle update utama
                });

                // 2. Load User Data
                onValue(ref(db, 'users/' + user.uid), (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        currentSaldo = data.saldo || 0;
                        currentLevel = data.level || 0;
                        currentEgg = data.egg || 0;
                        
                        // Set Tier Data dinamis dari database
                        const tier = data.tier || 'Free';
                        // Cek apakah globalTiers sudah dimuat, jika belum pakai default
                        if (globalTiers && globalTiers[tier]) {
                            currentTierData = globalTiers[tier];
                        } else {
                            // Fallback jika data belum sampat
                            currentTierData = { reward: 500, quota: 500, egg: 5 }; 
                        }
                        
                        // Update UI Info Cards (Sesuai Database)
                        document.getElementById('user-tier-display').innerText = tier;
                        document.getElementById('user-reward-display').innerText = (currentTierData.reward || 0) + ' Koin';
                        document.getElementById('user-quota-display').innerText = (currentTierData.quota || 0) + ' Level';

                        document.getElementById('user-name').innerText = data.nama || "User";
                        document.getElementById('balance-coin').innerText = currentSaldo.toLocaleString();
                        
                        renderSaldo();
                        
                        document.getElementById('egg-count').innerText = currentEgg;
                        checkLevelStatus(currentLevel);
                    }
                });
            } else { window.location.href = "index.html"; }
        });

        window.generateQuiz = function() {
            const num1 = Math.floor(Math.random() * 9) + 1;
            const num2 = 1;
            quizResult = num1 - num2;
            document.getElementById('math-question').innerText = `${num1} - ${num2} ?`;
            
            // Update coin reward text in modal (Dinamis)
            document.getElementById('coin-reward-text').innerText = (currentTierData.reward || 0) + ' Koin';

            const nextLevel = currentLevel + 1;
            const bonusItem = document.getElementById('bonus-egg-item');
            // Logika Bonus Telur: Setiap kelipatan 4 level
            if (nextLevel % 4 === 0) {
                bonusItem.classList.remove('hidden');
                // Update teks telur sesuai database
                const eggReward = currentTierData.egg || 5;
                document.getElementById('egg-reward-text').innerText = `+${eggReward} Telur`;
                
                document.getElementById('modal-title').innerText = "Bonus Telur!";
                document.getElementById('modal-icon').innerText = "ðŸ¥š";
            } else {
                bonusItem.classList.add('hidden');
                document.getElementById('modal-title').innerText = "Selamat!";
                document.getElementById('modal-icon').innerText = "ðŸŽ‰";
            }
            resetModalVisual();
        }

        function resetModalVisual() {
            const input = document.getElementById('math-answer');
            const btn = document.getElementById('btn-klaim');
            input.value = ""; input.classList.remove('correct');
            btn.disabled = true;
            btn.className = "btn-inactive w-full py-4 rounded-2xl font-black text-white text-lg shadow-lg uppercase tracking-widest";
            document.getElementById('success-notif').classList.add('hidden');
        }

        document.getElementById('math-answer').oninput = function() {
            const val = parseInt(this.value);
            if (val === quizResult) {
                playSound('correct'); this.classList.add('correct');
                document.getElementById('success-notif').classList.remove('hidden');
                document.getElementById('btn-klaim').disabled = false;
                document.getElementById('btn-klaim').className = "btn-active w-full py-4 rounded-2xl font-black text-white text-lg shadow-lg active:scale-95 transition-all uppercase tracking-widest";
            } else {
                this.classList.remove('correct');
                document.getElementById('success-notif').classList.add('hidden');
            }
        };

        document.getElementById('tap-area').onclick = (e) => {
            if (!currentUser || energy >= 30 || currentLevel >= currentTierData.quota) return;
            const birdImg = document.getElementById('bird-img');
            birdImg.classList.remove('animate-bird-right', 'animate-bird-left');
            void birdImg.offsetWidth; 
            if (lastJumpSide === 'left') { birdImg.classList.add('animate-bird-right'); lastJumpSide = 'right'; }
            else { birdImg.classList.add('animate-bird-left'); lastJumpSide = 'left'; }
            playSound('tap'); energy++;
            document.getElementById('energy-bar').style.width = (energy / 30 * 100) + "%";
            document.getElementById('energy-text').innerText = energy + "/30";
            const pwr = document.createElement('div');
            pwr.innerHTML = 'âš¡'; pwr.className = 'floating-energy text-xl';
            pwr.style.left = e.pageX + 'px'; pwr.style.top = e.pageY + 'px';
            document.body.appendChild(pwr);
            setTimeout(() => pwr.remove(), 800);
            if (energy >= 30) { generateQuiz(); document.getElementById('modal-klaim').classList.remove('hidden'); }
        };

        document.getElementById('btn-klaim').onclick = (e) => {
            const btnRect = e.target.getBoundingClientRect();
            const startX = btnRect.left + (btnRect.width / 2);
            const startY = btnRect.top + (btnRect.height / 2);
            document.getElementById('modal-klaim').classList.add('hidden');
            
            setTimeout(() => {
                flyCoinsToBalance(startX, startY);
                const newLevel = currentLevel + 1;
                const newSaldo = currentSaldo + (currentTierData.reward || 0); // Gunakan reward dari DB
                let newEgg = currentEgg;

                if (newLevel % 4 === 0) {
                    const eggBonus = currentTierData.egg || 5; // Gunakan bonus telur dari DB
                    newEgg += eggBonus;
                    setTimeout(() => flyEggsToBalance(startX, startY), 400);
                }

                update(ref(db, 'users/' + currentUser.uid), { 
                    saldo: newSaldo, level: newLevel, egg: newEgg
                }).then(() => {
                    energy = 0;
                    document.getElementById('energy-bar').style.width = "0%";
                    document.getElementById('energy-text').innerText = "0/30";

                    if (newLevel >= currentTierData.quota) {
                        setTimeout(() => {
                            document.getElementById('modal-locked').classList.remove('hidden');
                        }, 2000);
                    } else if (newLevel % 4 === 0) {
                        setTimeout(() => {
                            document.getElementById('upgrade-level-info').innerText = `${newLevel}/${currentTierData.quota}`;
                            document.getElementById('modal-upgrade').classList.remove('hidden');
                        }, 2000); 
                    }
                });
            }, 300);
        };
    </script>
</body>
</html>